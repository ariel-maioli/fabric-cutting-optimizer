<!DOCTYPE html>
<html lang="es" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Optimización de Corte de Tela</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
    <script>
      (function () {
        try {
          var stored = window.localStorage.getItem('fabric-theme');
          if (stored) {
            document.documentElement.setAttribute('data-theme', stored);
            return;
          }
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.setAttribute('data-theme', 'dark');
          }
        } catch (err) {
          /* no-op */
        }
      })();
    </script>
  </head>
  <body>
    <header class="app-header">
      <div class="branding">
        <h1>PeeP Rosario</h1>
        <p>Optimizador de corte para rollos de tela</p>
      </div>
      <div class="app-header__actions">
        <button
          type="button"
          class="settings-trigger"
          id="fabricSettingsTrigger"
          aria-haspopup="dialog"
          aria-controls="fabricSettingsModal"
          aria-expanded="false"
        >
          <span class="settings-trigger__icon" aria-hidden="true">⚙</span>
          <span class="settings-trigger__label">Tela / GAPs</span>
        </button>
        <button type="button" class="theme-switch" aria-label="Cambiar tema" role="switch" aria-checked="false" id="themeToggle">
          <span class="theme-switch__icon" aria-hidden="true">◑</span>
          <span class="theme-switch__label">Claro</span>
        </button>
      </div>
    </header>

    <div class="modal" id="fabricSettingsModal" hidden>
      <div class="modal__overlay" data-modal-dismiss="true" aria-hidden="true"></div>
      <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="fabricSettingsTitle">
        <div class="modal__header">
          <div>
            <p class="modal__eyebrow">Preferencias</p>
            <h2 class="modal__title" id="fabricSettingsTitle">Configuración de tela y GAPs</h2>
          </div>
          <button type="button" class="ghost modal__close" aria-label="Cerrar configuración" data-modal-dismiss="true">✕</button>
        </div>
        <div class="modal__body">
          <section class="quick-config" aria-label="Configuración rápida">
            <div class="quick-config__grid">
              <div class="param-section param-section--compact" aria-label="Especificación de tela">
                <div class="param-section__title-row">
                  <h3 class="param-title">Tela</h3>
                </div>
                <div class="param-row param-row--triple" role="group" aria-label="Tela">
                  <div class="numeric-field">
                    <label for="fabricWidth">Ancho <button type="button" class="info-trigger" aria-label="Ancho fijo del rollo de tela. Valor en centímetros (cm)." data-tooltip="Ancho fijo del rollo de tela. Valor en centímetros (cm)." data-tooltip-id="fabricTooltip">ⓘ</button></label>
                    <input
                      id="fabricWidth"
                      name="fabricWidth"
                      class="numeric-input numeric-input--ancho"
                      type="number"
                      inputmode="numeric"
                      pattern="[0-9]*"
                      min="1"
                      max="999"
                      step="1"
                      data-max-digits="3"
                      value="180"
                      oninput="this.value = this.value.replace(/\D/g, '').slice(0, this.dataset.maxDigits || 3);"
                    />
                  </div>
                  <div class="numeric-field">
                    <label for="marginX">Margen 1 <button type="button" class="info-trigger" aria-label="Margen aplicado a ambos lados de la tela. Valor en centímetros (cm)." data-tooltip="Margen aplicado a ambos lados de la tela. Valor en centímetros (cm)." data-tooltip-id="fabricTooltip">ⓘ</button></label>
                    <input
                      id="marginX"
                      name="marginX"
                      class="numeric-input numeric-input--short"
                      type="number"
                      inputmode="numeric"
                      pattern="[0-9]*"
                      min="0"
                      max="99"
                      step="1"
                      data-max-digits="2"
                      value="1"
                      oninput="this.value = this.value.replace(/\D/g, '').slice(0, this.dataset.maxDigits || 2);"
                    />
                  </div>
                  <div class="numeric-field">
                    <label for="marginY">Margen 2 <button type="button" class="info-trigger" aria-label="Margen aplicado al inicio y fin del largo de la tela. Valor en centímetros (cm)." data-tooltip="Margen aplicado al inicio y fin del largo de la tela. Valor en centímetros (cm)." data-tooltip-id="fabricTooltip">ⓘ</button></label>
                    <input
                      id="marginY"
                      name="marginY"
                      class="numeric-input numeric-input--short"
                      type="number"
                      inputmode="numeric"
                      pattern="[0-9]*"
                      min="0"
                      max="99"
                      step="1"
                      data-max-digits="2"
                      value="1"
                      oninput="this.value = this.value.replace(/\D/g, '').slice(0, this.dataset.maxDigits || 2);"
                    />
                  </div>
                </div>
              </div>
              <div class="param-section param-section--compact" aria-label="GAPs">
                <div class="param-section__title-row">
                  <h3 class="param-title">GAPs</h3>
                </div>
                <div class="param-row param-row--double" role="group" aria-label="GAPs">
                  <div class="numeric-field">
                    <label for="gapX">Gap H <button type="button" class="info-trigger" aria-label="Separación horizontal entre piezas. Valor en centímetros (cm)." data-tooltip="Separación horizontal entre piezas. Valor en centímetros (cm)." data-tooltip-id="fabricTooltip">ⓘ</button></label>
                    <input
                      id="gapX"
                      name="gapX"
                      class="numeric-input numeric-input--short"
                      type="number"
                      inputmode="numeric"
                      pattern="[0-9]*"
                      min="0"
                      max="99"
                      step="1"
                      data-max-digits="2"
                      value="1"
                      oninput="this.value = this.value.replace(/\D/g, '').slice(0, this.dataset.maxDigits || 2);"
                    />
                  </div>
                  <div class="numeric-field">
                    <label for="gapY">Gap V <button type="button" class="info-trigger" aria-label="Separación vertical entre filas. Valor en centímetros (cm)." data-tooltip="Separación vertical entre filas. Valor en centímetros (cm)." data-tooltip-id="fabricTooltip">ⓘ</button></label>
                    <input
                      id="gapY"
                      name="gapY"
                      class="numeric-input numeric-input--short"
                      type="number"
                      inputmode="numeric"
                      pattern="[0-9]*"
                      min="0"
                      max="99"
                      step="1"
                      data-max-digits="2"
                      value="1"
                      oninput="this.value = this.value.replace(/\D/g, '').slice(0, this.dataset.maxDigits || 2);"
                    />
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
        <div class="modal__footer">
          <button type="button" class="secondary" data-modal-dismiss="true">Cerrar</button>
          <button type="button" class="primary" id="saveFabricSettingsBtn">Guardar</button>
        </div>
      </div>
    </div>

    <main class="app-shell">
      <section class="panel form-panel" aria-labelledby="formTitle">
        <div class="panel-header">
          <h2 id="formTitle">Parámetros</h2>
        </div>
        <form id="configForm" novalidate>
            <div class="param-section param-section--scroll" aria-label="Tipos de corte">
              <div class="piece-section__header piece-section__header--sticky">
                <div class="piece-section__meta">
                  <div class="piece-section__title">
                    <h3 class="param-title piece-section__heading">
                      Cortes
                      <button
                        type="button"
                        class="info-trigger"
                        aria-label="El campo ID es para identificar cada corte y es editable. Todas las medidas son en cm."
                        data-tooltip="El campo ID es para identificar cada corte y es editable. Todas las medidas son en cm."
                      >ⓘ</button>
                    </h3>
                  </div>
                  <p class="helper-text piece-section__count" id="pieceLimitHelper">0 / 10 tipos configurados</p>
                </div>
              </div>
            <div id="pieceList" class="piece-list" role="list" aria-live="polite"></div>
          </div>

          <div class="form-footer">
            <div class="form-footer__actions" aria-label="Acciones de configuración">
              <button type="button" class="secondary" id="addPieceBtn">Agregar corte</button>
              <button type="button" class="primary optimize-btn" id="quickOptimizeBtn">Optimizar</button>
            </div>
            <div class="status" id="formStatus" aria-live="polite"></div>
          </div>
        </form>
      </section>

      <section class="panel metrics-panel" aria-labelledby="metricsTitle">
        <div class="panel-header metrics-panel__header">
          <h2 id="metricsTitle">Métricas</h2>
        </div>
        <dl class="metrics" id="metricsList">
          <div>
            <dt>
              Ancho de tela
              <button
                type="button"
                class="info-trigger"
                aria-label="Ancho fijo del rollo configurado."
                data-tooltip="Ancho fijo del rollo configurado."
              >ⓘ</button>
            </dt>
            <dd id="metricFabricWidth">--</dd>
          </div>
          <div>
            <dt>
              Largo total
              <span
                class="info-tip"
                role="button"
                tabindex="0"
                aria-label="Largo total de tela necesario para ubicar todas las piezas según el layout actual."
                data-tooltip="Largo total de tela necesario para ubicar todas las piezas según el layout actual."
              >ⓘ</span>
            </dt>
            <dd id="metricLength">--</dd>
          </div>
          <div>
            <dt>
              Uso de tela
              <button
                type="button"
                class="info-trigger"
                aria-label="Porcentaje del área total de la tela que se aprovecha con los cortes configurados."
                data-tooltip="Porcentaje del área total de la tela que se aprovecha con los cortes configurados."
              >ⓘ</button>
            </dt>
            <dd id="metricUsage">--</dd>
          </div>
          <div>
            <dt>
              Desperdicio
              <button
                type="button"
                class="info-trigger"
                aria-label="Porcentaje de tela desperdiciada respecto del área total disponible."
                data-tooltip="Porcentaje de tela desperdiciada respecto del área total disponible."
              >ⓘ</button>
            </dt>
            <dd id="metricWaste">--</dd>
          </div>
          <div>
            <dt>
              Piezas
              <span
                class="info-tip"
                role="button"
                tabindex="0"
                aria-label="Cantidad total de piezas colocadas en el layout, sumando todos los tipos de corte."
                data-tooltip="Cantidad total de piezas colocadas en el layout, sumando todos los tipos de corte."
              >ⓘ</span>
            </dt>
            <dd id="metricPieces">--</dd>
          </div>
        </dl>
      </section>

      <section class="panel preview-panel" aria-labelledby="previewTitle">
        <div class="panel-header">
          <div class="preview-header__top">
            <div class="preview-title-block">
              <h2 id="previewTitle">Previsualización</h2>
              <p class="preview-status" aria-live="polite" aria-atomic="true"></p>
            </div>
            <button
              type="button"
              class="primary"
              id="exportBtn"
              aria-label="Exporta la previsualización actual como imagen PNG."
              data-tooltip="Exporta la previsualización actual como imagen PNG."
            >Exportar PNG</button>
          </div>
        </div>
        <div class="preview-stage-wrapper" aria-live="polite">
          <canvas id="previewCanvas" width="960" height="520" role="img" aria-label="Distribución de cortes sobre la tela"></canvas>
        </div>
      </section>
    </main>

    <template id="pieceRowTemplate">
      <article class="piece-row" data-piece-row data-cut-id="">
        <div class="piece-row__header">
          <label class="field-group piece-row__id-field">
            <span>ID:</span>
            <input type="text" name="pieceLabel" data-field="label" maxlength="25" />
          </label>
          <button type="button" class="ghost" data-action="remove" aria-label="Eliminar corte">✕</button>
        </div>
        <div class="piece-row__grid">
          <label class="field-group">
            <span>Ancho (cm)</span>
            <input
              type="number"
              step="1"
              min="1"
              inputmode="numeric"
              pattern="[0-9]*"
              name="pieceWidth"
              data-field="width"
              data-max-digits="3"
              oninput="this.value = this.value.replace(/\D/g, '').slice(0, this.dataset.maxDigits || 3);"
            />
          </label>
          <label class="field-group">
            <span>Alto (cm)</span>
            <input
              type="number"
              step="1"
              min="1"
              inputmode="numeric"
              pattern="[0-9]*"
              name="pieceHeight"
              data-field="height"
              data-max-digits="3"
              oninput="this.value = this.value.replace(/\D/g, '').slice(0, this.dataset.maxDigits || 3);"
            />
          </label>
          <label class="field-group">
            <span>Cantidad</span>
            <input
              type="number"
              min="0"
              step="1"
              inputmode="numeric"
              pattern="[0-9]*"
              name="pieceQuantity"
              data-field="quantity"
              data-max-digits="3"
              oninput="this.value = this.value.replace(/\D/g, '').slice(0, this.dataset.maxDigits || 3);"
            />
          </label>
        </div>
      </article>
    </template>

    <script src="assets/js/app.js" defer></script>
  </body>
</html>
